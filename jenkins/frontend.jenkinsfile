pipeline {
    agent any

    environment {
        AWS_S3_BUCKET = 'settlyai-frontend-eleanor-practice'
        AWS_REGION = 'ap-southeast-2'
        SOURCE_DIR = 'frontend/dist'
        CLOUDFRONT_DISTRIBUTION_ID = credentials('CLOUDFRONT_DISTRIBUTION_ID') // stored in Jenkins credentials
        NODE_VERSION = '22'
        PNPM_VERSION = '9'
    }

    stages {
        stage('Checkout Code') {
            steps {
                checkout scm
            }
        }

        stage('Setup Node.js & pnpm') {
            steps {
                sh '''
                    curl -fsSL https://deb.nodesource.com/setup_${NODE_VERSION}.x | sudo -E bash -
                    sudo apt-get install -y nodejs
                    curl -fsSL https://get.pnpm.io/install.sh | sh -

                    echo 'export PNPM_HOME="$HOME/.local/share/pnpm"' >> ~/.bashrc
                    echo 'export PATH="$PNPM_HOME:$PATH"' >> ~/.bashrc
                    source ~/.bashrc

                    pnpm --version
                '''
            }
        }

        stage('Install Dependencies') {
            steps {
                dir('frontend') {
                    sh 'pnpm install --frozen-lockfile'
                }
            }
        }

        stage('Lint') {
            steps {
                dir('frontend') {
                    sh 'pnpm run lint'
                }
            }
        }

        stage('Format') {
            steps {
                dir('frontend') {
                    sh 'pnpm run format'
                }
            }
        }

        // Uncomment this if you want to run tests
        // stage('Test') {
        //     steps {
        //         dir('frontend') {
        //             sh 'pnpm run test'
        //         }
        //     }
        // }

        stage('Build Frontend') {
            steps {
                dir('frontend') {
                    sh 'pnpm exec vite build'
                }
            }
        }


        stage('Upload to S3') {
            steps {
                sh '''
                    aws s3 sync frontend/dist s3://${AWS_S3_BUCKET} --delete
                '''
            }
        }

        stage('Invalidate CloudFront') {
            steps {
                sh '''
                    aws cloudfront create-invalidation \
                      --distribution-id $CLOUDFRONT_DISTRIBUTION_ID \
                      --paths "/*"
                '''
            }
        }
    }
}